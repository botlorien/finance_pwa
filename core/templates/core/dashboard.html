{% extends 'base.html' %}
{% block content %}
<div class="container mt-3">
    <h4 class="text-center mb-3">📊 Dashboard</h4>

    <form method="get" class="row g-2 mb-4">
      <div class="col-md-4">
          <label for="ano" class="form-label">Ano</label>
          <select name="ano" id="ano" class="form-select">
              <option value="">Todos</option>
              {% for a in anos %}
                  <option value="{{ a }}" {% if a|stringformat:"s" == ano %}selected{% endif %}>{{ a }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="col-md-4">
          <label for="mes" class="form-label">Mês</label>
          <select name="mes" id="mes" class="form-select">
              <option value="">Todos</option>
              {% for m in meses %}
                  <option value="{{ m }}" {% if m|stringformat:"s" == mes %}selected{% endif %}>{{ m }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="col-md-4">
          <label for="item" class="form-label">Item</label>
          <select name="item" id="item" class="form-select">
              <option value="">Todos</option>
              {% for i in itens %}
                  <option value="{{ i }}" {% if i == item_nome %}selected{% endif %}>{{ i }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="col-12 text-end mt-2">
          <button class="btn btn-primary">🔍 Filtrar</button>
      </div>
  </form>
  

    <!-- Gráfico Despesa/Receita/Saldo -->
    <canvas id="graficoResumo" class="mb-4"></canvas>

    <!-- Top 5 Despesas -->
    <h6>🥇 Top 5 Despesas</h6>
    <ul class="list-group mb-3">
        {% for d in top_despesas %}
            <li class="list-group-item d-flex justify-content-between">
                <span>{{ d.item__nome }}</span>
                <strong>R$ {{ d.total|default:"0.00" }}</strong>
            </li>
        {% empty %}
            <li class="list-group-item text-muted">Nenhuma despesa encontrada</li>
        {% endfor %}
    </ul>

    <!-- Top 5 Receitas -->
    <h6>💰 Top 5 Receitas</h6>
    <ul class="list-group mb-3">
        {% for r in top_receitas %}
            <li class="list-group-item d-flex justify-content-between">
                <span>{{ r.item__nome }}</span>
                <strong>R$ {{ r.total|default:"0.00" }}</strong>
            </li>
        {% empty %}
            <li class="list-group-item text-muted">Nenhuma receita encontrada</li>
        {% endfor %}
    </ul>

    <!-- Despesas Recorrentes -->
    <h6>🔁 Despesas Recorrentes</h6>
    <ul class="list-group mb-3">
        {% for dr in despesas_repetidas %}
            <li class="list-group-item d-flex justify-content-between">
                <span>{{ dr.item__nome }}</span>
                <small>Presente em {{ dr.qtd }} meses</small>
            </li>
        {% empty %}
            <li class="list-group-item text-muted">Nenhuma despesa recorrente</li>
        {% endfor %}
    </ul>
</div>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('graficoResumo').getContext('2d');
const graficoResumo = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Despesas', 'Receitas', 'Saldo'],
        datasets: [{
            label: 'Valores',
            data: [{{ total_despesa }}, {{ total_receita }}, {{ saldo }}],
            backgroundColor: [
                'rgba(220, 53, 69, 0.8)',
                'rgba(25, 135, 84, 0.8)',
                'rgba(13, 110, 253, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        }
    }
});
</script>
{% endblock %}
